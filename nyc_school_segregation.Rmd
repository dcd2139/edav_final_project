---
title: "final-edav-project"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
```

```{r}
library(extracat)
library(dplyr)
library(tidyverse)
library(choroplethrZip)
data(zip.regions)
#school_seg = read.csv2("/Users/meenakshizutshi/Documents/Columbia/edav/final-project/2013_-_2018_Demographic_Snapshot_School.csv", header=TRUE, sep=",")
delim = ","  # or is it "\t" ?
dec = "."    # or is it "," ?
school_seg <- read.csv("/Users/meenakshizutshi/Documents/Columbia/edav/final-project/2013_-_2018_Demographic_Snapshot_School.csv", header=TRUE, sep=delim, dec=dec, stringsAsFactors=FALSE)


#extract the Borough names from DBN mame parterns
school_seg$Borough <-  
  ifelse((substr(school_seg$DBN, 3,3) == "M"), "MANHATTAN",
         ifelse((substr(school_seg$DBN, 3,3) == "X"), "BRONX",
                ifelse((substr(school_seg$DBN, 3,3) == "K"), "BROOKLYN",
                       ifelse((substr(school_seg$DBN, 3,3) == "Q"), "QUEENS",
                              ifelse(substr(school_seg$DBN, 3,3) == "R", "STATEN IS", "something else")))))

#data cleaning
school_seg$X..Asian.1<- as.numeric(school_seg$X..Asian.1)
school_seg$X..Black.1 <- as.numeric(school_seg$X..Black.1)
school_seg$X..White.1 <- as.numeric(school_seg$X..White.1)
school_seg$X..Hispanic.1 <- as.numeric(school_seg$X..Hispanic.1)
school_seg$X..Multiple.Race.Categories.Not.Represented.1 <- as.numeric(school_seg$X..Multiple.Race.Categories.Not.Represented.1)

#later use for comparisons:
df_enrolled_students <- school_seg[,c("DBN","Year","Total.Enrollment")]
colnames(df_enrolled_students) <- c("DBN","Year","Number_of_enrolled_students")


```
###1. Missing data analysis

```{r}
#visna(school_seg, sort = "r")

# No missing data
```


###2. Total students population in each borough bar chart

```{r}
school_seg$Total.Enrollment <- as.numeric(school_seg$Total.Enrollment)

ggplot(school_seg, aes(x = Borough, y = Total.Enrollment)) + 
  geom_bar(stat = "identity", color = "skyblue") +
  ylab("Number of Students") +
  labs(title = "Total number of students enrolled in each Borough")

```

###3. Percentage of students for each race

```{r}

#add few columns to total_students_by_race
total_students_by_race <- school_seg[,c("X..Asian", "X..Black", "X..White", "X..Hispanic","X..Multiple.Race.Categories.Not.Represented")]

colnames(total_students_by_race) <- c("Asian", "Black", "White", "Hispanic", "Other")

tidy_data_students_per_race <- total_students_by_race %>% gather(race, number_of_students, Asian:Other)

tidy_data_students_per_race %>%
  group_by(race) %>%
  summarise(total_pop = sum(number_of_students)) %>%
  mutate(pop_percent = total_pop/sum(total_pop)) %>%
 ggplot(aes(x = reorder(race, -pop_percent), pop_percent, fill = race)) +
  xlab("") + geom_bar(stat = "identity") + 
  ylab("Percentage of Students") + 
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Percentage of Students for each race") 

```


###4. Race segregation in NYC schools by Boroughs

```{r}


#calculate segregation score
get_seg_score <- function(row) {
  colname = row["top_race_name"][[1]]
  top_pct = as.numeric(row[[colname]])
  return((top_pct * 1.25) - 25)
}

#add few columns to df_1
df_1 <- school_seg[,c("DBN","Year","Borough","X..Asian.1", "X..Black.1", "X..White.1", "X..Hispanic.1","X..Multiple.Race.Categories.Not.Represented.1")]

df_1$top_race <- apply(df_1, 1, which.max)
df_1$top_race_name <- sapply(df_1[,"top_race"], function(x) names(df_1)[[x]])
df_1$seg_score <- apply(df_1, 1, get_seg_score)
#df_1$Borough <- school_seg[, "Borough"]

#rename column names 

colnames(df_1) <- c("DBN","Year","Borough", "Asian", "Black", "White", "Hispanic", "Multi_race", "Top_race", "Top_race_name", "Segregation_score")

df_2 = df_1 %>%
  group_by(Borough) %>%
  summarise_at(vars(Asian, Black, White, Hispanic, Multi_race), funs(sum)) 

df_2$total <- apply(df_2[,2:6], 1, sum)

df_3 <- df_2 %>%
  mutate_if(is.numeric, funs(./total))

#convert messy to tidy data 
long_df <- df_3 %>% gather(race, race_proportion, Asian:Multi_race)

ggplot(long_df, aes(Borough, race_proportion, fill = race)) + 
  geom_col() + 
  labs(title = "Race distribution by Borough") +
  ylab("Race proportion")



```

###5. Percent of schools where each race is the largest race per borough - Stacked bar

```{r}

df_by_boro = df_1 %>%
  group_by(Borough, Top_race_name) 

df_top_counts_by_boro = count(df_by_boro)

ggplot(df_top_counts_by_boro, aes(fill=Top_race_name, x=Borough, y=n)) + 
  geom_bar(stat="identity", position="fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(title="Percent of schools with most common race",
       y="Percent of schools")


```


###6. Mean Segregation score per borough and (by top race )over time

```{r}

#Mean Segregation score per borough and (by top race )over time
df_seg_sc = df_1 %>%
  group_by(Borough, Year) %>%
  summarise(mean_seg_score = mean(Segregation_score)) 

ggplot(df_seg_sc, aes(Year, mean_seg_score, group=Borough, color=Borough)) +
  geom_line(size=1) +
  labs(title = "Mean Segregation score per borough over time") +
  ylab("Mean segregation score per Borough over time")

#Mean Segregation score per by top race over time
df_seg_sc_r = df_1 %>%
  group_by(Top_race_name, Year) %>%
  summarise(mean_seg_score = mean(Segregation_score)) 

ggplot(df_seg_sc_r, aes(Year, mean_seg_score, group=Top_race_name, color=Top_race_name)) +
  geom_line(size=1) +
  labs(title = "Mean Segregation score per top race over time") +
  ylab("Mean segregation score per top race over time")



```


###8. Race segregation analysis in NYC schools by zip code

```{r}
HOME_DIR = "/Users/meenakshizutshi/Documents/Columbia/edav/final-project/"
school_location_2018 = read.csv2(paste(HOME_DIR, "2018_DOE_High_School_Directory.csv", sep=""), sep=",")
school_location_2017 = read.csv2(paste(HOME_DIR, "2017_DOE_High_School_Directory.csv", sep=""), sep=",")
school_location_2016 = read.csv2(paste(HOME_DIR, "2016_DOE_High_School_Directory.csv", sep=""), sep=",")
school_location_2013 = read.csv2(paste(HOME_DIR, "2013_DOE_High_School_Directory.csv", sep=""), sep=",")
middle_school_loc_2018 = read.csv2(paste(HOME_DIR, "2018_DOE_Middle_School_Directory.csv", sep=""), sep=",")
prek_school_loc_2018 = read.csv2(paste(HOME_DIR, "2018_DOE_Pre-K_School_Directory.csv", sep=""), sep=",")
```


```{r}
a <- data.frame(school_location_2018$dbn, school_location_2018$Borough, school_location_2018$Postcode, school_location_2018$Longitude, school_location_2018$Latitude)
colnames(a) <- c("DBN", "Borough", "Postcode", "Longitude","Latitude")

b <- data.frame(school_location_2017$dbn, school_location_2017$Borough, school_location_2017$Postcode, school_location_2017$Longitude, school_location_2017$Latitude)
colnames(b) <- c("DBN", "Borough", "Postcode", "Longitude","Latitude")

c <- data.frame(school_location_2016$dbn, school_location_2016$borough, school_location_2016$Postcode, school_location_2016$Longitude, school_location_2016$Latitude)
colnames(c) <- c("DBN", "Borough", "Postcode", "Longitude","Latitude")

e <- data.frame(school_location_2013$DBN, school_location_2013$Boro , school_location_2013$Postcode, school_location_2013$longitude, school_location_2013$latitude)
colnames(e) <- c("DBN", "Borough", "Postcode", "Longitude","Latitude")

middle_school <- data.frame(middle_school_loc_2018$schooldbn, middle_school_loc_2018$Borough, middle_school_loc_2018$Postcode, middle_school_loc_2018$Longitude, middle_school_loc_2018$Latitude)
colnames(middle_school) <- c("DBN", "Borough", "Postcode", "Longitude","Latitude")

pre_school <- data.frame(prek_school_loc_2018$schooldbn, prek_school_loc_2018$borough, prek_school_loc_2018$Postcode, prek_school_loc_2018$Longitude, prek_school_loc_2018$Latitude)
colnames(pre_school) <- c("DBN", "Borough", "Postcode", "Longitude","Latitude")
```


```{r}
all_rows <- bind_rows(a,b,c,e, middle_school, pre_school)
all_rows_for_dbn <- distinct(all_rows, DBN, .keep_all= TRUE)

df_with_zips <- left_join(df_1, all_rows_for_dbn, by = "DBN")
df_with_zips <- df_with_zips[complete.cases(df_with_zips),]
```

```{r}
# Installing packages 
#install.packages("devtools")
#devtools::install_github('arilamstein/choroplethrZip@v1.5.0')


```

```{r}

# Race segregation analysis in NYC schools by zip code for 5 years data 2013-2018
df_seg_score <- df_with_zips[, c("Postcode", "Segregation_score")]

df_seg_score <- df_seg_score %>%
  group_by(Postcode) %>%
  summarise(mean_seg_score = mean(Segregation_score))

colnames(df_seg_score) <- c("region", "value")

df_seg_score$region <- as.character(df_seg_score$region)

valid_zips = intersect(df_seg_score$region, zip.regions$region)

zip_choropleth(df_seg_score,
               zip_zoom = c(valid_zips),
               title = "Segregation Score by Zip-Code",
               legend = "Segregation Score")




```


###7. Most common race by zip code in choropleth  

```{r}
# TODO: For this part, Top race has to be calculated again after grouping by zip-code.
# After that we can choose the plotted value to be the name of the race rather than
# the mean race which is wrong.

#df_dbn <- school_seg
#df_with_zips <- left_join(df_dbn, all_rows_for_dbn, by = "DBN")

# df_top_race <- df_with_zips[, c("Postcode", "Top_race")]
# df_top_race <- df_top_race %>%
#   group_by(Postcode) %>%
#   summarise(mean_seg_score = mean(Top_race))
# 
# colnames(df_top_race) <- c("region", "value")
# df_top_race$region <- as.character(df_top_race$region)
# 
# valid_zips = intersect(df_top_race$region, zip.regions$region)
# zip_choropleth(df_top_race,
#                zip_zoom = c(valid_zips),
#                title = "Most common race by Zip-Code",
#                legend = "Most Common race")

```


###9. Race segregation analysis in NYC schools by zip code for 2017-18 data

```{r}

##5 years
df_with_zips_students <- left_join(df_enrolled_students, all_rows_for_dbn, by = "DBN")
df_with_zips_students <- df_with_zips_students[complete.cases(df_with_zips_students),]
df_with_zips_students <- df_with_zips_students[, c("Postcode", "Number_of_enrolled_students")]

df_students <- df_with_zips_students %>%
  group_by(Postcode) %>%
  summarise(sum_students = sum(Number_of_enrolled_students))

colnames(df_students) <- c("region", "value")
df_students$region <- as.character(df_students$region)
valid_zips_students= intersect(df_students$region, zip.regions$region)

zip_choropleth(df_students,
               zip_zoom = c(valid_zips_students),
               title = "Total enrolled students by Zip-Code",
               legend = "Total enrolled students")

### Race segregation analysis in NYC schools by zip code for 2017-18 data
enrollment_df_2017 = subset(df_enrolled_students, Year == "2017-18")
df_with_zips_2017_subset <- left_join(enrollment_df_2017, all_rows_for_dbn, by = "DBN")
df_with_zips_2017_subset <- df_with_zips_2017_subset[complete.cases(df_with_zips_2017_subset),]
df_enrolled_students_2017 <- df_with_zips_2017_subset[, c("Postcode", "Number_of_enrolled_students")]

df_students_2017 <- df_enrolled_students_2017 %>%
  group_by(Postcode) %>%
  summarise(sum_students = sum(Number_of_enrolled_students))

colnames(df_students_2017) <- c("region", "value")
df_students_2017$region <- as.character(df_students_2017$region)
valid_zips_2017 = intersect(df_students_2017$region, zip.regions$region)

zip_choropleth(df_students_2017,
               zip_zoom = c(valid_zips_2017),
               title = "Total enrolled students by Zip-Code for 2017-18",
               legend = "Total enrolled students")


```

